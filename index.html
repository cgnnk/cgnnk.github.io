<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Mamoball Turkey League</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary-red: #cc0000;
            --dark-bg: #0b0c10;
            --card-bg: rgba(255,255,255,.06);
            --text-main: #eef0f3;
            --text-dim: rgba(238,240,243,.68);
            --danger: #ff4444;
            --success: #00c851;
            --border: rgba(255,255,255,.12);
            --shadow-soft: 0 10px 28px rgba(0,0,0,.35);
            --radius: 16px;
            --ring: 0 0 0 3px rgba(204,0,0,.25);
        }

        * {
            box-sizing: border-box
        }

        html {
            scroll-behavior: smooth
        }

        body {
            font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
            margin: 0;
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            background: radial-gradient(900px 500px at 18% -10%, rgba(204,0,0,.25), transparent 60%), radial-gradient(800px 520px at 90% 0%, rgba(255,255,255,.10), transparent 60%), linear-gradient(180deg,#08090d 0%,var(--dark-bg) 35%,#07070b 100%);
        }

        .container {
            width: min(1200px,92%);
            margin: auto
        }

        .page {
            padding: 18px 0 60px
        }

        header {
            background: rgba(9,10,14,.72);
            backdrop-filter: blur(14px);
            padding: 12px 0;
            border-bottom: 1px solid rgba(204,0,0,.55);
            position: sticky;
            top: 0;
            z-index: 2000;
            box-shadow: 0 10px 28px rgba(0,0,0,.35);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px
        }

        .logo-box {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 200px
        }

        .main-logo {
            height: 44px;
            width: 44px;
            border-radius: 50%;
            border: 2px solid rgba(204,0,0,.85);
            background: #fff;
            box-shadow: 0 10px 25px rgba(0,0,0,.35);
        }

        .brand {
            display: flex;
            flex-direction: column;
            line-height: 1.1
        }

            .brand h1 {
                margin: 0;
                font-size: 1.05rem;
                letter-spacing: .06em;
                font-weight: 900;
                text-transform: uppercase
            }

            .brand span {
                font-size: .78rem;
                color: var(--text-dim);
                margin-top: 2px
            }

        nav {
            display: flex;
            align-items: center;
            gap: 6px
        }

            nav a {
                color: var(--text-main);
                text-decoration: none;
                font-weight: 800;
                cursor: pointer;
                font-size: .78rem;
                text-transform: uppercase;
                letter-spacing: .06em;
                padding: 10px 10px;
                border-radius: 999px;
                transition: .22s ease;
                border: 1px solid transparent;
                user-select: none;
            }

                nav a:hover {
                    color: #fff;
                    border-color: rgba(255,255,255,.12);
                    background: rgba(255,255,255,.06);
                    transform: translateY(-1px)
                }

        .hamburger {
            display: none;
            flex-direction: column;
            gap: 6px;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.05);
        }

            .hamburger span {
                width: 24px;
                height: 3px;
                background: #fff;
                border-radius: 2px;
                transition: .25s ease
            }

        @media (max-width:768px) {
            nav {
                position: fixed;
                top: 0;
                right: -100%;
                width: min(360px,78%);
                height: 100vh;
                background: rgba(20,21,26,.92);
                backdrop-filter: blur(16px);
                border-left: 1px solid rgba(255,255,255,.12);
                flex-direction: column;
                justify-content: center;
                align-items: stretch;
                transition: .35s ease;
                gap: 12px;
                padding: 22px;
                z-index: 2500;
            }

                nav.active {
                    right: 0
                }

                nav a {
                    width: 100%;
                    text-align: center;
                    padding: 12px 14px;
                    border-radius: 14px;
                    background: rgba(255,255,255,.05);
                    border: 1px solid rgba(255,255,255,.10);
                }

                    nav a:hover {
                        transform: none;
                        background: rgba(255,255,255,.08)
                    }

            .hamburger {
                display: flex
            }
        }

        .admin-section, .league-card, .news-card, .stats-card, .week-container {
            background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
            border: 1px solid var(--border);
            box-shadow: var(--shadow-soft);
            border-radius: var(--radius);
            padding: 18px;
            margin-top: 18px;
            width: 100%;
        }

        h2 {
            border-left: 4px solid rgba(204,0,0,.9);
            padding-left: 15px;
            margin-top: 36px;
            margin-bottom: 12px;
            font-size: clamp(1.1rem,2.2vw,1.35rem);
        }

        h3 {
            color: rgba(204,0,0,.95);
            margin: 0 0 14px 0;
            font-size: 1.05rem;
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        input, textarea, select {
            background: rgba(10,10,14,.65);
            border: 1px solid rgba(255,255,255,.14);
            color: #fff;
            padding: 12px 12px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 10px;
            outline: none;
            transition: .2s ease;
        }

            input::placeholder, textarea::placeholder {
                color: rgba(255,255,255,.45)
            }

            input:focus, textarea:focus, select:focus {
                border-color: rgba(204,0,0,.55);
                box-shadow: var(--ring)
            }

        textarea {
            resize: vertical;
            min-height: 90px
        }

        button {
            background: linear-gradient(180deg, rgba(204,0,0,1), rgba(170,0,0,1));
            color: #fff;
            border: 1px solid rgba(255,255,255,.12);
            padding: 12px 14px;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 900;
            width: 100%;
            transition: .22s ease;
            box-shadow: 0 12px 26px rgba(204,0,0,.18);
        }

            button:hover {
                opacity: .92;
                transform: translateY(-1px)
            }

            button:active {
                transform: translateY(0);
                opacity: .96
            }

            button:focus {
                outline: none;
                box-shadow: var(--ring)
            }

        .btn-danger {
            background: linear-gradient(180deg, rgba(255,68,68,1), rgba(210,45,45,1)) !important;
            box-shadow: 0 12px 26px rgba(255,68,68,.14)
        }

        .btn-small {
            width: auto !important;
            padding: 6px 10px !important;
            font-size: 11px;
            border-radius: 10px
        }

        .linkbtn {
            width: auto !important;
            padding: 9px 12px !important;
            font-size: 12px;
            border-radius: 12px;
            background: rgba(255,255,255,.06) !important;
            border: 1px solid rgba(255,255,255,.14);
            box-shadow: none
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(320px,1fr));
            gap: 16px
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(340px,1fr));
            gap: 16px
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
            gap: 16px
        }

        .news-img {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,.03);
            border: 1px solid rgba(255,255,255,.10);
            display: block;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap
        }

        .pill {
            padding: 4px 10px;
            border: 1px solid rgba(255,255,255,.16);
            border-radius: 999px;
            font-size: 12px;
            color: rgba(255,255,255,.75);
            background: rgba(255,255,255,.05);
            white-space: nowrap
        }

        .muted {
            color: var(--text-dim);
            font-size: .9rem
        }

        .mini-card {
            background: rgba(255,255,255,.05);
            border: 1px solid rgba(255,255,255,.12);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: .18s ease;
        }

            .mini-card:hover {
                transform: translateY(-2px);
                border-color: rgba(255,255,255,.18);
                box-shadow: 0 14px 28px rgba(0,0,0,.25)
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: .92rem;
            border-radius: 12px;
            overflow: hidden
        }

        td, th {
            padding: 11px 8px;
            border-bottom: 1px solid rgba(255,255,255,.10);
            text-align: left;
            vertical-align: middle
        }

        th {
            color: rgba(255,255,255,.8);
            font-size: .82rem;
            text-transform: uppercase;
            letter-spacing: .08em;
            background: rgba(255,255,255,.03)
        }

        tr:hover td {
            background: rgba(255,255,255,.03)
        }

        .team-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0
        }

        .team-logo-small {
            width: 30px;
            height: 30px;
            object-fit: contain;
            border-radius: 8px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.10);
            flex: 0 0 auto;
        }

        .match-row, .fixture-item {
            display: grid;
            grid-template-columns: 40px 1fr 70px 1fr 40px;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(255,255,255,.04);
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.10);
        }

        .match-row {
            cursor: pointer
        }

        .score-container, .tire-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            font-weight: 900;
            font-size: 1.05rem;
            color: rgba(204,0,0,.95)
        }

        .score-box {
            background: rgba(255,255,255,.06);
            color: #fff;
            width: 34px;
            height: 34px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.12);
            font-size: .95rem;
            box-shadow: 0 10px 20px rgba(0,0,0,.25);
        }

        .team-home, .team-away {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800
        }

        .team-home {
            justify-content: flex-start
        }

        .team-away {
            justify-content: flex-end
        }

        .week-title {
            background: linear-gradient(180deg, rgba(204,0,0,1), rgba(165,0,0,1));
            padding: 8px 10px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-weight: 900;
            font-size: .85rem;
            letter-spacing: .06em;
            text-transform: uppercase;
            box-shadow: 0 14px 28px rgba(204,0,0,.16);
        }

        #loader {
            position: fixed;
            inset: 0;
            background: radial-gradient(900px 600px at 20% 0%, rgba(204,0,0,.18), transparent 60%), linear-gradient(180deg,#07070b 0%,#0b0c10 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-weight: 900;
            letter-spacing: .06em;
            text-transform: uppercase;
        }

            #loader::after {
                content: "";
                width: 14px;
                height: 14px;
                border-radius: 999px;
                margin-left: 10px;
                border: 2px solid rgba(255,255,255,.22);
                border-top-color: rgba(204,0,0,.95);
                animation: spin .8s linear infinite;
            }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        @media (max-width:560px) {
            .match-row, .fixture-item {
                grid-template-columns: 28px 1fr 64px 1fr 10px;
                padding: 10px
            }

            .score-box {
                width: 32px;
                height: 32px
            }

            .team-logo-small {
                width: 28px;
                height: 28px
            }

            nav {
                width: 82%
            }
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 18px;
        }

        .modal {
            width: min(980px,96%);
            max-height: 86vh;
            overflow: auto;
            background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
            border: 1px solid rgba(255,255,255,.16);
            box-shadow: 0 18px 50px rgba(0,0,0,.55);
            border-radius: 18px;
            padding: 16px;
        }

            .modal .close {
                width: auto
            }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        @media (max-width:900px) {
            .grid-2 {
                grid-template-columns: 1fr
            }
        }

        .roster-card {
            background: rgba(255,255,255,.04);
            border: 1px solid rgba(255,255,255,.10);
            border-radius: 14px;
            padding: 12px
        }

        .tiny-input {
            width: 64px !important;
            margin: 0 !important;
            padding: 8px 10px !important;
            border-radius: 10px !important;
            text-align: center;
            font-weight: 900;
        }
    </style>
</head>

<body>
    <div id="loader">Veriler Y√ºkleniyor...</div>

    <header>
        <div class="container header-content">
            <div class="logo-box">
                <img src="logo.png" alt="MBTL" class="main-logo" loading="lazy" decoding="async"
                     referrerpolicy="no-referrer" onerror="this.src='https://via.placeholder.com/45?text=MB'">
                <div class="brand">
                    <h1>MAMOBALL TURKEY LEAGUE</h1>
                    <span>discord.gg/mbtl</span>
                </div>
            </div>

            <div class="hamburger" onclick="toggleMenu()" aria-label="Men√º">
                <span></span><span></span><span></span>
            </div>

            <nav id="nav-menu">
                <a onclick="handleNav('news')">Haberler</a>
                <a onclick="handleNav('standings')">Puan Durumu</a>
                <a onclick="handleNav('fixture')">Fikst√ºr</a>
                <a onclick="handleNav('stats')">Krallƒ±k</a>
                <a onclick="handleNav('matches')">Sonu√ßlar</a>
                <a onclick="handleNav('teams')">Takƒ±mlar</a>
                <a onclick="handleNav('players')">Oyuncular</a>
                <a onclick="handleNav('admin')">Admin</a>
            </nav>
        </div>
    </header>

    <div class="container page">

        <!-- Admin Auth -->
        <section id="admin-auth" class="admin-section" style="display:none; text-align:center; padding:40px 20px;">
            <h2>Y√∂netici Eri≈üimi</h2>
            <p class="muted">Bu b√∂l√ºme eri≈ümek i√ßin yetkili Google hesabƒ± ile giri≈ü yapmalƒ±sƒ±nƒ±z.</p>
            <button onclick="loginWithGoogle()"
                    style="display:flex;align-items:center;justify-content:center;gap:10px;background:#fff;color:#444;border:1px solid #ddd;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Google ile Giri≈ü Yap
            </button>
        </section>

        <!-- Admin Panel -->
        <section id="admin-panel" class="admin-section" style="display:none;">
            <div class="row" style="margin-bottom:14px;">
                <h2 style="margin:0;border:none;padding:0;">Y√∂netim Paneli</h2>
                <button onclick="logout()" class="btn-danger" style="width:auto;">√áƒ±kƒ±≈ü</button>
            </div>

            <div class="admin-grid">
                <div>
                    <h3>Haber Y√∂netimi</h3>
                    <input type="text" id="news-title" placeholder="Ba≈ülƒ±k">
                    <input type="text" id="news-image-url" placeholder="Haber G√∂rsel Linki (https://...png)">
                    <div class="muted">G√∂rsel linki https olmalƒ± ve m√ºmk√ºnse direkt .png/.jpg dosyasƒ± olmalƒ±.</div>
                    <textarea id="news-content" placeholder="ƒ∞√ßerik... (Enter veya <br> kullanabilirsin)" rows="3"></textarea>
                    <button onclick="publishNews()">Yayƒ±nla</button>

                    <div class="league-card" style="margin-top:14px;">
                        <h3>Discord Webhook</h3>
                        <div class="muted">A≈üaƒüƒ±ya webhook URL yazarsan; haber/ma√ß sonucu girildiƒüinde Discord‚Äôa otomatik mesaj gider.</div>
                        <input type="text" id="webhook-input" placeholder="https://discord.com/api/webhooks/....">
                        <button class="linkbtn" onclick="saveWebhook()">Webhook Kaydet</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Haberler -->
        <section id="news-section">
            <h2>Haberler</h2>
            <div id="news-container" class="news-grid"></div>
        </section>

        <!-- Puan Durumu -->
        <section id="standings-section" style="display:none;">
            <h2>Puan Durumu</h2>
            <div class="muted">Tie-breaker: √ñnce Puan, sonra Averaj (GD), sonra ƒ∞kili Averaj (H2H Puan, H2H GD), sonra Atƒ±lan Gol.</div>
            <div id="leagues-container"></div>

            <div id="admin-standings-tools" class="league-card" style="display:none;">
                <h3>Lig & Takƒ±m Y√∂netimi</h3>
                <input type="text" id="league-name-input" placeholder="Yeni Lig Adƒ± (√∂rn: World Cup [Sezon 1])">
                <button onclick="addLeague()" style="margin-bottom:10px;">Lig Ekle</button>

                <select id="team-league-select"><option value="">Lig Se√ßin</option></select>
                <input type="text" id="team-name" placeholder="Takƒ±m Adƒ±">
                <input type="text" id="team-id-input" placeholder="Takƒ±m ID (√ñrn: #TUR123) - opsiyonel">
                <input type="text" id="team-logo-input" placeholder="Logo Linki (URL)">
                <button onclick="addTeam()" style="margin-bottom:6px;">Takƒ±m Ekle</button>
                <button onclick="deleteLeague()" class="btn-danger">Ligi Sil</button>

                <div class="muted" style="margin-top:10px">
                    Logo linki: https olmalƒ± ve m√ºmk√ºnse direkt .png/.jpg linki olmalƒ± (bazƒ± siteler hotlink engeller).
                </div>
            </div>
        </section>

        <!-- Fikst√ºr -->
        <section id="fixture-section" style="display:none;">
            <h2>Fikst√ºr</h2>
            <div id="fixture-display-container"></div>

            <div id="admin-fixture-tools" class="league-card" style="display:none;">
                <h3>Fikst√ºr Y√∂netimi</h3>
                <select id="fixture-league-select"><option value="">Lig Se√ßin</option></select>
                <button onclick="generateFixture()" style="background:linear-gradient(180deg,#6a1b9a,#4f1471);margin-bottom:6px;">Fikst√ºr Olu≈ütur</button>
                <button onclick="deleteFixture()" class="btn-danger">Fikst√ºr√º Temizle</button>
            </div>
        </section>

        <!-- ƒ∞statistikler -->
        <section id="stats-section" style="display:none;">
            <h2>ƒ∞statistikler</h2>
            <div class="muted">Artƒ±k krallƒ±k sayfalarƒ± manuel giri≈üten deƒüil, ma√ß detaylarƒ±ndan otomatik hesaplanƒ±r.</div>
            <div id="stats-display-container"></div>
        </section>

        <!-- Ma√ß Sonu√ßlarƒ± -->
        <section id="matches-section" style="display:none;">
            <h2>Ma√ß Sonu√ßlarƒ±</h2>
            <div class="muted">Bir ma√ßa tƒ±klayƒ±nca ma√ß detaylarƒ± (gol/asist/cs) a√ßƒ±lƒ±r.</div>
            <div id="matches-display-container"></div>

            <div id="admin-matches-tools" class="league-card" style="display:none;">
                <h3>Ma√ß Sonucu & Detay Giri≈üi</h3>

                <select id="match-league-select" onchange="onMatchLeagueChanged()"><option value="">Lig Se√ßin</option></select>
                <select id="match-week-select"><option value="">Hafta Se√ßin</option></select>

                <div style="display:flex;flex-direction:column;gap:8px;">
                    <select id="team-1-select" onchange="renderMatchDetailInputs()"><option value="">Ev Sahibi Se√ßin</option></select>

                    <div style="display:flex;gap:8px;">
                        <input type="number" id="score-1" placeholder="0">
                        <input type="number" id="score-2" placeholder="0">
                    </div>

                    <select id="team-2-select" onchange="renderMatchDetailInputs()"><option value="">Deplasman Se√ßin</option></select>
                </div>

                <div id="match-detail-inputs" style="margin-top:12px;"></div>

                <button onclick="addMatchWithDetails()"
                        style="margin-top:10px;background:linear-gradient(180deg, rgba(0,200,81,1), rgba(0,150,61,1));box-shadow:0 12px 26px rgba(0,200,81,.12);">
                    Skor + ƒ∞statistikleri Onayla
                </button>

                <div class="muted" style="margin-top:10px">
                    Not: ƒ∞statistikler ma√ßƒ±n i√ßine g√∂m√ºl√ºr. Krallƒ±k & puan durumu t√ºm ma√ßlarƒ± tarayarak dinamik hesaplanƒ±r.
                </div>
            </div>
        </section>

        <!-- Takƒ±mlar -->
        <section id="teams-section" style="display:none;">
            <h2>Takƒ±mlar</h2>
            <div id="teams-list"></div>
            <div id="teams-detail" class="league-card" style="display:none;"></div>
        </section>

        <!-- Oyuncular -->
        <section id="players-section" style="display:none;">
            <h2>Oyuncular</h2>

            <div id="admin-players-tools" class="league-card" style="display:none;">
                <h3>Oyuncu Y√∂netimi (ID)</h3>

                <select id="player-create-league"><option value="">Lig Se√ßin</option></select>
                <input type="text" id="player-id-input" placeholder="Oyuncu ID (√ñrn: #P9A2X7)">
                <input type="text" id="player-name-input" placeholder="Oyuncu Adƒ±">
                <button onclick="createOrOverwritePlayer()" style="margin-bottom:10px;">Oyuncu Olu≈ütur / G√ºncelle</button>

                <select id="player-assign-league" onchange="updateAssignTeams()"><option value="">Lig Se√ßin</option></select>
                <select id="player-assign-team"><option value="">Takƒ±m Se√ßin</option></select>
                <input type="text" id="player-assign-id" placeholder="Oyuncu ID ile ekle (√ñrn: #P9A2X7)">
                <button onclick="assignPlayerToTeam()"
                        style="background:linear-gradient(180deg, rgba(0,200,81,1), rgba(0,150,61,1));box-shadow:0 12px 26px rgba(0,200,81,.12);">
                    Takƒ±ma Ekle
                </button>

                <div class="muted" style="margin-top:10px">
                    ƒ∞pucu: Bir oyuncunun adƒ± ‚ÄúOyuncu‚Äù g√∂r√ºn√ºyorsa √∂nce √ºstten oyuncu kaydƒ± olu≈üturup adƒ±nƒ± gir.
                </div>
            </div>

            <div id="players-list"></div>
            <div id="players-detail" class="league-card" style="display:none;"></div>
        </section>

    </div>

    <!-- Match Detail Modal -->
    <div id="match-modal-backdrop" class="modal-backdrop" onclick="closeMatchModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="row" style="margin-bottom:10px;">
                <div>
                    <div id="match-modal-title" style="font-size:1.15rem;font-weight:1000"></div>
                    <div id="match-modal-sub" class="muted"></div>
                </div>
                <button class="btn-danger btn-small close" onclick="closeMatchModal()">Kapat</button>
            </div>
            <div id="match-modal-body"></div>
        </div>
    </div>

    <script>
        // ---------- DOM helpers ----------
        const $ = (id) => document.getElementById(id);
        const qs = (sel) => document.querySelector(sel);

        // ---------- Firebase ----------
        const firebaseConfig = {
            apiKey: "AIzaSyApw-_f4nfbHwbZhe9-HB5oaA3CsBadWVs",
            authDomain: "mamoball-turkey-league.firebaseapp.com",
            databaseURL: "https://mamoball-turkey-league-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "mamoball-turkey-league",
            storageBucket: "mamoball-turkey-league.firebasestorage.app",
            messagingSenderId: "648815784565",
            appId: "1:648815784565:web:5d82e86c1db870cd53fe3c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // ---------- Discord Webhook ----------
        let DISCORD_WEBHOOK_URL = "";

        async function sendDiscordWebhook(payload) {
            try {
                if (!DISCORD_WEBHOOK_URL || !DISCORD_WEBHOOK_URL.startsWith("https://")) return;
                await fetch(DISCORD_WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.warn("Webhook g√∂nderilemedi:", e);
            }
        }

        function saveWebhook() {
            const v = ($('webhook-input')?.value || "").trim();
            if (v && !v.startsWith("https://")) return alert("Webhook https ile ba≈ülamalƒ±!");
            DISCORD_WEBHOOK_URL = v;
            save(); // settings i√ßinde saklanacak
            alert("Webhook kaydedildi!");
        }

        // ---------- State ----------
        let newsData = [], leagues = {}, leaguesMeta = {}, fixtures = {};
        let players = []; // registry: { id, playerId, name }
        let matches = []; // { id, league, week, t1Id,t2Id, s1,s2, createdAt, details:{ [teamInternalId]:[{playerId,g,a,cs}] } }
        let settings = { webhookUrl: "" };

        let isAdmin = false;

        // ---------- Helpers ----------
        function normalizeHashId(input) {
            if (!input) return null;
            let v = String(input).trim();
            if (!v.startsWith('#')) v = '#' + v;
            return v;
        }
        function isValidHashId(input) {
            const v = normalizeHashId(input);
            return !!v && /^#[A-Za-z0-9]+$/.test(v);
        }
        function makeId(prefix) {
            const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
            return '#' + prefix + Date.now().toString(36).toUpperCase().slice(-4) + rand;
        }
        function esc(s) {
            return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }
        function makeSafeKey(s) {
            // Firebase key g√ºvenli (.[#$/[]] yok)
            return String(s || "").trim().replace(/[.#$\/\[\]]/g, " ").replace(/\s+/g, " ").trim();
        }
        function renderNewsContent(content) {
            let safe = esc(content || '');
            safe = safe.replace(/&lt;br\s*\/?&gt;/gi, '<br>');
            safe = safe.replace(/\n/g, '<br>');
            return safe;
        }
        function nowTR() {
            return new Date().toLocaleString('tr-TR');
        }

        // ---------- Menu / Nav ----------
        function toggleMenu() {
            qs('.hamburger')?.classList.toggle('active');
            $('nav-menu')?.classList.toggle('active');
        }
        function handleNav(tab) {
            qs('.hamburger')?.classList.remove('active');
            $('nav-menu')?.classList.remove('active');

            ['news', 'standings', 'fixture', 'stats', 'matches', 'teams', 'players'].forEach(t => {
                const sec = $(t + '-section');
                if (sec) sec.style.display = 'none';
            });

            if ($('admin-auth')) $('admin-auth').style.display = 'none';
            if ($('admin-panel')) $('admin-panel').style.display = 'none';

            if (tab === 'admin') {
                if (isAdmin) $('admin-panel') && ($('admin-panel').style.display = 'block');
                else $('admin-auth') && ($('admin-auth').style.display = 'block');
                return;
            }
            const target = $(tab + '-section');
            if (target) target.style.display = 'block';
        }

        // ---------- Admin Auth ----------
        const AUTHORIZED_ADMINS = ["cgnk06@gmail.com", "scaevus.94@gmail.com"];

        auth.onAuthStateChanged((user) => {
            if (user && AUTHORIZED_ADMINS.includes(user.email)) {
                isAdmin = true;
                console.log("Admin giri≈üi:", user.email);
            } else {
                isAdmin = false;
                if (user) console.warn("Yetkisiz giri≈ü:", user.email);
            }
            refreshAdminVisibility();
            renderAll();
            if (isAdmin && $('admin-auth') && $('admin-auth').style.display === 'block') handleNav('admin');
            $('loader') && ($('loader').style.display = 'none');
        });

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    if (!AUTHORIZED_ADMINS.includes(result.user.email)) {
                        alert("Bu hesap y√∂netici yetkisine sahip deƒüil!");
                        logout();
                    }
                })
                .catch((error) => {
                    console.error("Giri≈ü hatasƒ±:", error);
                    alert("Giri≈ü yapƒ±lamadƒ±: " + error.message);
                });
        }
        function logout() {
            auth.signOut().then(() => {
                isAdmin = false;
                location.reload();
            });
        }
        function refreshAdminVisibility() {
            const show = isAdmin ? 'block' : 'none';
            $('admin-standings-tools') && ($('admin-standings-tools').style.display = show);
            $('admin-fixture-tools') && ($('admin-fixture-tools').style.display = show);
            $('admin-matches-tools') && ($('admin-matches-tools').style.display = show);
            $('admin-players-tools') && ($('admin-players-tools').style.display = show);
        }

        // ---------- Data migration / normalize ----------
        function normalizeData() {
            // leagues object->array fix
            Object.keys(leagues || {}).forEach(k => {
                if (Array.isArray(leagues[k])) return;
                if (leagues[k] && typeof leagues[k] === "object") {
                    leagues[k] = Object.values(leagues[k]).filter(v => v && typeof v === "object" && !Array.isArray(v));
                }
            });

            // leaguesMeta fallback
            Object.keys(leagues || {}).forEach(k => { if (!leaguesMeta[k]) leaguesMeta[k] = k; });

            // teams normalize
            Object.keys(leagues || {}).forEach(l => {
                if (!Array.isArray(leagues[l])) return;
                leagues[l].forEach(t => {
                    if (!t || t.id === "dummy") return;
                    if (!t.teamId || !isValidHashId(t.teamId)) t.teamId = makeId('T');
                    else t.teamId = normalizeHashId(t.teamId);
                    if (!Array.isArray(t.roster)) t.roster = [];
                    if (t.puan == null) t.puan = 0;
                    if (t.averaj == null) t.averaj = 0;
                });
            });

            // players registry normalize
            players = Array.isArray(players) ? players : [];
            players.forEach(p => {
                if (!p.playerId || !isValidHashId(p.playerId)) p.playerId = makeId('P');
                else p.playerId = normalizeHashId(p.playerId);
                if (!p.name) p.name = "Oyuncu";
                if (!p.id) p.id = Date.now() + Math.floor(Math.random() * 9999);
            });

            // settings
            settings = settings && typeof settings === "object" ? settings : { webhookUrl: "" };
            if (typeof settings.webhookUrl !== "string") settings.webhookUrl = "";
            DISCORD_WEBHOOK_URL = settings.webhookUrl || "";

            // matches normalize
            matches = Array.isArray(matches) ? matches : [];
            matches = matches.map(m => {
                const nm = Object.assign({}, m);
                if (!nm.id) nm.id = Date.now() + Math.floor(Math.random() * 9999);
                if (!nm.createdAt) nm.createdAt = Date.now();
                if (!nm.details || typeof nm.details !== "object") nm.details = {};
                nm.s1 = parseInt(nm.s1); nm.s2 = parseInt(nm.s2);
                if (Number.isNaN(nm.s1)) nm.s1 = 0;
                if (Number.isNaN(nm.s2)) nm.s2 = 0;
                return nm;
            });

            // ‚úÖ IMPORTANT: details migrate (eski object-key format -> yeni array format)
            matches = matches.map(m => {
                const nm = { ...m };
                const d = (nm.details && typeof nm.details === "object") ? nm.details : {};
                const migrated = {};

                Object.keys(d).forEach(teamInternalId => {
                    const v = d[teamInternalId];

                    // already array
                    if (Array.isArray(v)) {
                        migrated[teamInternalId] = v.map(it => ({
                            playerId: normalizeHashId(it.playerId),
                            g: parseInt(it.g) || 0,
                            a: parseInt(it.a) || 0,
                            cs: parseInt(it.cs) || 0
                        }));
                        return;
                    }

                    // old format: { "#pid": {g,a,cs}, ... }
                    if (v && typeof v === "object") {
                        migrated[teamInternalId] = Object.keys(v).map(pidKey => {
                            const r = v[pidKey] || {};
                            return {
                                playerId: normalizeHashId(pidKey),
                                g: parseInt(r.g) || 0,
                                a: parseInt(r.a) || 0,
                                cs: parseInt(r.cs) || 0
                            };
                        });
                        return;
                    }

                    migrated[teamInternalId] = [];
                });

                nm.details = migrated;
                return nm;
            });
        }

        // ---------- Save / Load ----------
        async function save() {
            try {
                settings.webhookUrl = DISCORD_WEBHOOK_URL || "";
                await db.ref('/').set({
                    news: newsData,
                    leagues: leagues,
                    leaguesMeta: leaguesMeta,
                    matches: matches,
                    players: players,
                    fixtures: fixtures,
                    settings: settings
                });
                renderAll();
                updateLeagueSelects();
                renderTeamsList();
                renderPlayersList();
            } catch (e) {
                console.error("Firebase write error:", e);
                alert("Kaydedilemedi! Firebase hatasƒ±: " + (e?.message || e));
            }
        }

        db.ref('/').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            newsData = data.news || [];
            leagues = data.leagues || {};
            leaguesMeta = data.leaguesMeta || {};
            matches = data.matches || [];
            players = data.players || [];
            fixtures = data.fixtures || {};
            settings = data.settings || { webhookUrl: "" };

            normalizeData();

            renderAll();
            updateLeagueSelects();
            renderTeamsList();
            renderPlayersList();
            refreshAdminVisibility();

            $('loader') && ($('loader').style.display = 'none');
        });

        // ---------- News ----------
        async function publishNews() {
            const t = ($('news-title')?.value || "").trim();
            const c = $('news-content')?.value || "";
            const img = ($('news-image-url')?.value || "").trim();

            if (!t || !c) return alert("Ba≈ülƒ±k ve i√ßerik zorunlu!");
            if (img && !img.startsWith("https://")) return alert("G√∂rsel linki https ile ba≈ülamalƒ±!");

            const item = { id: Date.now(), title: t, content: c, image: img, date: new Date().toLocaleDateString('tr-TR') };
            newsData.push(item);

            if ($('news-title')) $('news-title').value = "";
            if ($('news-content')) $('news-content').value = "";
            if ($('news-image-url')) $('news-image-url').value = "";

            await save();

            await sendDiscordWebhook({
                content: `üì∞ **Yeni Haber**\n**${t}**\n${c.replace(/\n/g, ' ')}`
            });
        }

        function deleteNews(id) {
            if (confirm("Silinsin mi?")) {
                newsData = newsData.filter(n => n.id !== id);
                save();
            }
        }

        function renderNews() {
            const wrap = $('news-container');
            if (!wrap) return;
            wrap.innerHTML = newsData.slice().reverse().map(n => `
            <div class="news-card">
              ${isAdmin ? `<button class="btn-danger btn-small" onclick="deleteNews(${n.id})" style="float:right">Sil</button>` : ''}
              <h3>${esc(n.title)}</h3>
              ${n.image ? `
                <img src="${esc(n.image)}" class="news-img" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                     onerror="this.style.display='none'">` : ''}
              <p>${renderNewsContent(n.content)}</p>
              <small class="muted">${esc(n.date)}</small>
            </div>
          `).join('');
        }

        // ---------- League / Team ----------
        function addLeague() {
            const inp = $('league-name-input');
            const displayName = (inp?.value || "").trim();
            if (!displayName) return alert("Lig adƒ± bo≈ü olamaz!");

            const key = makeSafeKey(displayName);
            if (!key) return alert("Lig adƒ± ge√ßersiz!");
            if (leagues[key]) return alert("Bu lig zaten var!");

            leagues[key] = [{
                id: "dummy", name: "Takƒ±m Ekleyin", logo: "", puan: 0, averaj: 0, teamId: "#DUMMY", roster: []
            }];
            leaguesMeta[key] = displayName;
            if (inp) inp.value = "";
            save();
        }

        function addTeam() {
            const l = $('team-league-select')?.value || "";
            const n = ($('team-name')?.value || "").trim();
            const rawTeamId = ($('team-id-input')?.value || "").trim();
            const teamId = rawTeamId ? normalizeHashId(rawTeamId) : makeId('T');
            const logo = ($('team-logo-input')?.value || "").trim();

            if (!l || !n) return;
            if (rawTeamId && !isValidHashId(rawTeamId)) return alert("Takƒ±m ID ge√ßersiz! (# ile ba≈ülayacak, sadece harf/rakam).");

            const allTeams = Object.values(leagues).flat().filter(x => x && x.id && x.id !== "dummy");
            if (allTeams.some(t => normalizeHashId(t.teamId) === normalizeHashId(teamId))) return alert("Bu takƒ±m ID zaten kullanƒ±lƒ±yor!");

            leagues[l] = (leagues[l] || []).filter(x => x.id !== "dummy");
            leagues[l].push({
                id: "T" + Date.now(),
                teamId,
                name: n,
                logo: logo || 'https://via.placeholder.com/30?text=?',
                puan: 0,
                averaj: 0,
                roster: []
            });

            save();
            alert("Takƒ±m Eklendi!");
        }

        function deleteLeague() {
            const l = $('team-league-select')?.value || "";
            const dn = leaguesMeta[l] || l;
            if (l && confirm(`${dn} silinsin mi?`)) {
                delete leagues[l];
                delete leaguesMeta[l];
                if (fixtures[l]) delete fixtures[l];
                matches = (matches || []).filter(m => m.league !== l);
                save();
            }
        }

        function getTeamById(leagueKey, internalTeamId) {
            const arr = leagues[leagueKey] || [];
            return arr.find(t => t && t.id !== "dummy" && t.id === internalTeamId) || null;
        }

        // ---------- Dynamic stats from matches ----------
        function getPlayerName(pid) {
            pid = normalizeHashId(pid);
            const p = (players || []).find(x => normalizeHashId(x.playerId) === pid);
            return p ? (p.name || "Oyuncu") : "Oyuncu";
        }

        function buildLeagueAggregates(leagueKey) {
            const teamStats = {};
            const playerStats = {};

            const lTeams = (leagues[leagueKey] || []).filter(t => t.id !== "dummy");
            lTeams.forEach(t => {
                teamStats[t.id] = { pts: 0, gd: 0, gf: 0, ga: 0, played: 0, w: 0, d: 0, l: 0 };
            });

            const lMatches = (matches || []).filter(m => m.league === leagueKey);
            lMatches.forEach(m => {
                const t1 = m.t1Id, t2 = m.t2Id;
                if (!teamStats[t1] || !teamStats[t2]) return;

                const s1 = parseInt(m.s1), s2 = parseInt(m.s2);
                if (Number.isNaN(s1) || Number.isNaN(s2)) return;

                teamStats[t1].played++; teamStats[t2].played++;
                teamStats[t1].gf += s1; teamStats[t1].ga += s2;
                teamStats[t2].gf += s2; teamStats[t2].ga += s1;
                teamStats[t1].gd += (s1 - s2);
                teamStats[t2].gd += (s2 - s1);

                if (s1 > s2) { teamStats[t1].pts += 3; teamStats[t1].w++; teamStats[t2].l++; }
                else if (s2 > s1) { teamStats[t2].pts += 3; teamStats[t2].w++; teamStats[t1].l++; }
                else { teamStats[t1].pts += 1; teamStats[t2].pts += 1; teamStats[t1].d++; teamStats[t2].d++; }

                // player aggregation from embedded details (ARRAY FORMAT)
                const details = m.details || {};
                [t1, t2].forEach(teamId => {
                    const list = Array.isArray(details[teamId]) ? details[teamId] : [];
                    list.forEach(item => {
                        const pid = normalizeHashId(item.playerId);
                        const g = parseInt(item.g) || 0;
                        const a = parseInt(item.a) || 0;
                        const cs = parseInt(item.cs) || 0;

                        const pName = getPlayerName(pid);
                        if (!playerStats[pid]) playerStats[pid] = { playerId: pid, name: pName, goals: 0, assists: 0, cs: 0 };
                        playerStats[pid].goals += g;
                        playerStats[pid].assists += a;
                        playerStats[pid].cs += cs;
                        if (pName && pName !== "Oyuncu") playerStats[pid].name = pName;
                    });
                });
            });

            return { teamStats, playerStats, lMatches };
        }

        // ---------- Head-to-head ----------
        function computeH2H(leagueKey, teamAId, teamBId) {
            const out = { aPts: 0, bPts: 0, aGf: 0, bGf: 0, aGd: 0, bGd: 0 };
            const lMatches = (matches || []).filter(m => m.league === leagueKey);
            lMatches.forEach(m => {
                const isAB = (m.t1Id === teamAId && m.t2Id === teamBId) || (m.t1Id === teamBId && m.t2Id === teamAId);
                if (!isAB) return;

                const s1 = parseInt(m.s1), s2 = parseInt(m.s2);
                if (Number.isNaN(s1) || Number.isNaN(s2)) return;

                let aScore = 0, bScore = 0;
                if (m.t1Id === teamAId) { aScore = s1; bScore = s2; }
                else { aScore = s2; bScore = s1; }

                out.aGf += aScore; out.bGf += bScore;
                out.aGd += (aScore - bScore);
                out.bGd += (bScore - aScore);

                if (aScore > bScore) out.aPts += 3;
                else if (bScore > aScore) out.bPts += 3;
                else { out.aPts += 1; out.bPts += 1; }
            });
            return out;
        }

        function standingsComparator(leagueKey, teamStats) {
            return (A, B) => {
                const a = teamStats[A.id] || { pts: 0, gd: 0, gf: 0 };
                const b = teamStats[B.id] || { pts: 0, gd: 0, gf: 0 };

                if (b.pts !== a.pts) return b.pts - a.pts;
                if (b.gd !== a.gd) return b.gd - a.gd;

                const h = computeH2H(leagueKey, A.id, B.id);
                if (h.aPts !== h.bPts) return h.bPts - h.aPts;
                if (h.aGd !== h.bGd) return h.bGd - h.aGd;

                if (b.gf !== a.gf) return b.gf - a.gf;

                return String(A.name || "").localeCompare(String(B.name || ""), 'tr');
            };
        }

        function renderStandings() {
            const container = $('leagues-container');
            if (!container) return;
            container.innerHTML = "";

            Object.keys(leagues || {}).forEach(l => {
                if (!Array.isArray(leagues[l])) return;

                const displayName = leaguesMeta[l] || l;
                const teams = (leagues[l] || []).filter(t => t.id !== "dummy");

                const { teamStats } = buildLeagueAggregates(l);
                const sorted = teams.slice().sort(standingsComparator(l, teamStats));

                let html = `<div class="league-card"><h3>${esc(displayName)}</h3>
              <table>
                <tr>
                  <th>#</th><th>Takƒ±m</th><th>O</th><th>G</th><th>B</th><th>M</th><th>AG</th><th>YG</th><th>AV</th><th>P</th>
                </tr>`;

                sorted.forEach((t, i) => {
                    const st = teamStats[t.id] || { played: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0 };
                    html += `<tr>
                <td>${i + 1}</td>
                <td class="team-cell">
                  <img src="${esc(t.logo)}" class="team-logo-small" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                       onerror="this.src='https://via.placeholder.com/30?text=?'">
                  ${esc(t.name)} <span class="pill">${esc(t.teamId)}</span>
                </td>
                <td>${st.played}</td>
                <td>${st.w}</td>
                <td>${st.d}</td>
                <td>${st.l}</td>
                <td>${st.gf}</td>
                <td>${st.ga}</td>
                <td><b>${st.gd}</b></td>
                <td><b>${st.pts}</b></td>
              </tr>`;
                });

                container.innerHTML += html + `</table></div>`;
            });
        }

        // ---------- Fixture ----------
        function generateFixture() {
            const l = $('fixture-league-select')?.value || "";
            if (!l) return alert("Lig se√ßin!");

            let teams = (leagues[l] || []).filter(t => t.id !== "dummy").map(t => t.name);
            if (teams.length < 2) return;
            if (teams.length % 2 !== 0) teams.push("BAY");

            let totalRounds = teams.length - 1, rounds = [];
            for (let r = 0; r < totalRounds; r++) {
                let roundMatches = [];
                for (let m = 0; m < teams.length / 2; m++) {
                    let h = teams[m], a = teams[teams.length - 1 - m];
                    if (h !== "BAY" && a !== "BAY") roundMatches.push({ home: h, away: a });
                }
                rounds.push(roundMatches);
                teams.splice(1, 0, teams.pop());
            }
            fixtures[l] = [...rounds, ...rounds.map(rd => rd.map(m => ({ home: m.away, away: m.home })))];
            save();
            alert("Fikst√ºr Hazƒ±r!");
        }

        function deleteFixture() {
            const l = $('fixture-league-select')?.value || "";
            if (l && confirm("Silinsin mi?")) {
                delete fixtures[l];
                save();
            }
        }

        function renderFixture() {
            const container = $('fixture-display-container');
            if (!container) return;
            container.innerHTML = "";

            Object.keys(fixtures || {}).forEach(l => {
                let html = `<div class="league-card"><h3>${esc((leaguesMeta[l] || l))} Fikst√ºr√º</h3>`;
                (fixtures[l] || []).forEach((round, i) => {
                    html += `<div class="week-title" style="margin-top:10px">${i + 1}. Hafta</div>`;
                    (round || []).forEach(m => {
                        const lData = leagues[l] || [];
                        const t1 = lData.find(x => x.name === m.home) || {};
                        const t2 = lData.find(x => x.name === m.away) || {};
                        html += `<div class="fixture-item">
                  <div></div>
                  <div class="team-home">
                    <img src="${esc(t1.logo || '')}" class="team-logo-small" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                         onerror="this.src='https://via.placeholder.com/30?text=?'">
                    <span>${esc(m.home)}</span>
                  </div>
                  <div class="tire-container">-</div>
                  <div class="team-away">
                    <span>${esc(m.away)}</span>
                    <img src="${esc(t2.logo || '')}" class="team-logo-small" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                         onerror="this.src='https://via.placeholder.com/30?text=?'">
                  </div>
                  <div></div>
                </div>`;
                    });
                });
                container.innerHTML += html + `</div>`;
            });
        }

        // ---------- Matches ----------
        function onMatchLeagueChanged() {
            updateMatchTeams();
            renderMatchDetailInputs();
        }

        function updateMatchTeams() {
            const l = $('match-league-select')?.value || "";
            const s1 = $('team-1-select');
            const s2 = $('team-2-select');
            if (!s1 || !s2) return;

            const prev1 = s1.value, prev2 = s2.value;

            s1.innerHTML = '<option value="">Ev Sahibi Se√ßin</option>';
            s2.innerHTML = '<option value="">Deplasman Se√ßin</option>';

            (leagues[l] || []).forEach(t => {
                if (t.id !== "dummy") {
                    const opt = `<option value="${esc(t.id)}">${esc(t.name)}</option>`;
                    s1.innerHTML += opt;
                    s2.innerHTML += opt;
                }
            });

            s1.value = prev1; s2.value = prev2;
        }

        function getTeamRosterPlayerIds(leagueKey, internalTeamId) {
            const t = getTeamById(leagueKey, internalTeamId);
            if (!t) return [];
            const roster = Array.isArray(t.roster) ? t.roster : [];
            return roster.map(normalizeHashId).filter(Boolean);
        }

        function renderMatchDetailInputs() {
            const wrap = $('match-detail-inputs');
            if (!wrap) return;

            const leagueKey = $('match-league-select')?.value || "";
            const t1Id = $('team-1-select')?.value || "";
            const t2Id = $('team-2-select')?.value || "";

            if (!leagueKey || !t1Id || !t2Id) {
                wrap.innerHTML = `<div class="muted">Takƒ±mlarƒ± se√ßince kadrolar otomatik listelenir (Gol/Asist/CS girebilirsin).</div>`;
                return;
            }
            if (t1Id === t2Id) {
                wrap.innerHTML = `<div class="muted">Aynƒ± takƒ±mƒ± iki tarafa se√ßemezsin.</div>`;
                return;
            }

            const t1 = getTeamById(leagueKey, t1Id);
            const t2 = getTeamById(leagueKey, t2Id);
            const r1 = getTeamRosterPlayerIds(leagueKey, t1Id);
            const r2 = getTeamRosterPlayerIds(leagueKey, t2Id);

            const renderRosterTable = (team, roster, side) => {
                const rows = roster.length ? roster.map(pid => {
                    const safePid = esc(pid);
                    const nm = esc(getPlayerName(pid));
                    return `
                <tr>
                  <td>${nm} <span class="pill">${safePid}</span></td>
                  <td style="width:80px"><input class="tiny-input" type="number" min="0" value="0" data-side="${side}" data-pid="${safePid}" data-field="g"></td>
                  <td style="width:80px"><input class="tiny-input" type="number" min="0" value="0" data-side="${side}" data-pid="${safePid}" data-field="a"></td>
                  <td style="width:80px"><input class="tiny-input" type="number" min="0" value="0" data-side="${side}" data-pid="${safePid}" data-field="cs"></td>
                </tr>`;
                }).join('') : `<tr><td colspan="4" class="muted">Kadro bo≈ü.</td></tr>`;

                return `
              <div class="roster-card">
                <div class="team-cell" style="margin-bottom:8px;">
                  <img class="team-logo-small" src="${esc(team?.logo || '')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                       onerror="this.src='https://via.placeholder.com/30?text=?'">
                  <div style="font-weight:1000">${esc(team?.name || 'Takƒ±m')}</div>
                </div>
                <table>
                  <tr><th>Oyuncu</th><th>Gol</th><th>Asist</th><th>CS</th></tr>
                  ${rows}
                </table>
              </div>`;
            };

            wrap.innerHTML = `
            <div class="grid-2">
              ${renderRosterTable(t1, r1, "home")}
              ${renderRosterTable(t2, r2, "away")}
            </div>
            <div class="muted" style="margin-top:10px">
              ƒ∞pucu: Sadece bu ma√ßtaki istatistikleri yaz. Krallƒ±k otomatik g√ºncellenir.
            </div>
          `;
        }

        function collectMatchDetails(leagueKey, t1Id, t2Id) {
            const details = {};
            details[t1Id] = [];
            details[t2Id] = [];

            const inputs = Array.from(document.querySelectorAll('#match-detail-inputs input[data-pid][data-field]'));
            const tmp = { [t1Id]: {}, [t2Id]: {} };

            inputs.forEach(inp => {
                const pid = normalizeHashId(inp.getAttribute('data-pid'));
                const field = inp.getAttribute('data-field');
                const side = inp.getAttribute('data-side');
                const val = parseInt(inp.value) || 0;

                const teamId = (side === "home") ? t1Id : t2Id;
                if (!tmp[teamId][pid]) tmp[teamId][pid] = { g: 0, a: 0, cs: 0 };
                tmp[teamId][pid][field] = val;
            });

            [t1Id, t2Id].forEach(teamId => {
                details[teamId] = Object.keys(tmp[teamId]).map(pid => ({
                    playerId: pid,
                    g: tmp[teamId][pid].g || 0,
                    a: tmp[teamId][pid].a || 0,
                    cs: tmp[teamId][pid].cs || 0
                }));
            });

            return details;
        }

        function formatTopLinesFromDetails(leagueKey, t1Id, t2Id, details) {
            const lines = [];
            const t1 = getTeamById(leagueKey, t1Id);
            const t2 = getTeamById(leagueKey, t2Id);

            function listForTeam(teamId) {
                const team = (teamId === t1Id) ? t1 : t2;
                const arr = (Array.isArray(details[teamId]) ? details[teamId] : []).map(item => ({
                    pid: normalizeHashId(item.playerId),
                    name: getPlayerName(item.playerId),
                    g: parseInt(item.g) || 0,
                    a: parseInt(item.a) || 0,
                    cs: parseInt(item.cs) || 0
                }));

                const scorers = arr.filter(x => x.g > 0).sort((a, b) => b.g - a.g).slice(0, 6);
                const assists = arr.filter(x => x.a > 0).sort((a, b) => b.a - a.a).slice(0, 6);
                const clean = arr.filter(x => x.cs > 0).sort((a, b) => b.cs - a.cs).slice(0, 6);

                lines.push(
                    scorers.length ? `‚öΩ ${team.name}: ${scorers.map(x => `${x.name}(${x.g})`).join(", ")}` : `‚öΩ ${team.name}: -`,
                    assists.length ? `üÖ∞Ô∏è ${team.name}: ${assists.map(x => `${x.name}(${x.a})`).join(", ")}` : `üÖ∞Ô∏è ${team.name}: -`,
                    clean.length ? `üß§ ${team.name}: ${clean.map(x => `${x.name}(${x.cs})`).join(", ")}` : `üß§ ${team.name}: -`,
                );
            }

            listForTeam(t1Id);
            listForTeam(t2Id);
            return lines;
        }

        async function addMatchWithDetails() {
            const l = $('match-league-select')?.value || "";
            const w = $('match-week-select')?.value || "";
            const t1Id = $('team-1-select')?.value || "";
            const t2Id = $('team-2-select')?.value || "";
            const s1 = parseInt($('score-1')?.value);
            const s2 = parseInt($('score-2')?.value);

            if (!l || !t1Id || !t2Id) return alert("Lig ve takƒ±mlarƒ± se√ßin!");
            if (t1Id === t2Id) return alert("Aynƒ± takƒ±m iki tarafa se√ßilemez!");
            if (Number.isNaN(s1) || Number.isNaN(s2)) return alert("Skor girin!");

            const t1 = getTeamById(l, t1Id);
            const t2 = getTeamById(l, t2Id);
            if (!t1 || !t2) return alert("Takƒ±m bulunamadƒ±!");

            const details = collectMatchDetails(l, t1Id, t2Id);

            const matchObj = {
                id: Date.now(),
                createdAt: Date.now(),
                league: l,
                week: w || "0",
                t1Id, t2Id,
                s1, s2,
                details
            };

            matches.push(matchObj);
            await save();
            alert("Ma√ß + istatistikler kaydedildi!");

            const lines = formatTopLinesFromDetails(l, t1Id, t2Id, details);
            await sendDiscordWebhook({
                content:
                    `üèÅ **Ma√ß Sonucu** (${leaguesMeta[l] || l} ‚Ä¢ ${w}. Hafta)
**${t1.name} ${s1} - ${s2} ${t2.name}**
‚è±Ô∏è ${nowTR()}

${lines.join('\n')}`
            });

            if ($('score-1')) $('score-1').value = "";
            if ($('score-2')) $('score-2').value = "";
            Array.from(document.querySelectorAll('#match-detail-inputs input[data-pid][data-field]')).forEach(inp => inp.value = "0");
        }

        function deleteMatch(id) {
            if (confirm("Silinsin mi?")) {
                matches = matches.filter(m => m.id !== id);
                save();
            }
        }

        function renderMatches() {
            const container = $('matches-display-container');
            if (!container) return;
            container.innerHTML = "";

            const grouped = (matches || []).reduce((acc, m) => {
                const wk = String(m.week ?? "0");
                (acc[wk] = acc[wk] || []).push(m);
                return acc;
            }, {});

            Object.keys(grouped).sort((a, b) => parseInt(b) - parseInt(a)).forEach(w => {
                let html = `<div class="week-container"><div class="week-title">${esc(w)}. Hafta</div>`;
                grouped[w].slice().reverse().forEach(m => {
                    const lData = leagues[m.league] || [];
                    const t1 = lData.find(x => x.id !== "dummy" && x.id === m.t1Id) || {};
                    const t2 = lData.find(x => x.id !== "dummy" && x.id === m.t2Id) || {};

                    html += `<div class="match-row" onclick="openMatchModal(${m.id})">
                <div style="display:flex;justify-content:center;">
                  ${isAdmin ? `<button class="btn-danger btn-small" onclick="event.stopPropagation(); deleteMatch(${m.id})">X</button>` : ''}
                </div>
                <div class="team-home">
                  <img src="${esc(t1.logo || '')}" class="team-logo-small" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                       onerror="this.src='https://via.placeholder.com/30?text=?'">
                  <span>${esc(t1.name || '')}</span>
                </div>
                <div class="score-container">
                  <div class="score-box">${esc(m.s1)}</div><span>-</span><div class="score-box">${esc(m.s2)}</div>
                </div>
                <div class="team-away">
                  <span>${esc(t2.name || '')}</span>
                  <img src="${esc(t2.logo || '')}" class="team-logo-small" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                       onerror="this.src='https://via.placeholder.com/30?text=?'">
                </div>
                <div></div>
              </div>`;
                });
                container.innerHTML += html + `</div>`;
            });
        }

        // ---------- Match Detail Modal ----------
        function closeMatchModal(e) {
            if (e && e.target && e.target.id !== "match-modal-backdrop") return;
            $('match-modal-backdrop') && ($('match-modal-backdrop').style.display = 'none');
        }

        function openMatchModal(matchId) {
            const m = (matches || []).find(x => x.id === matchId);
            if (!m) return;

            const leagueKey = m.league;
            const lName = leaguesMeta[leagueKey] || leagueKey;
            const t1 = getTeamById(leagueKey, m.t1Id) || {};
            const t2 = getTeamById(leagueKey, m.t2Id) || {};
            const title = `${t1.name || ''} ${m.s1} - ${m.s2} ${t2.name || ''}`;

            $('match-modal-title') && ($('match-modal-title').innerHTML = esc(title));
            $('match-modal-sub') && ($('match-modal-sub').innerHTML = `${esc(lName)} ‚Ä¢ ${esc(m.week)}. Hafta`);

            const details = m.details || {};

            const renderTeamDetail = (team, teamId) => {
                // ‚úÖ array format
                const list = Array.isArray(details[teamId]) ? details[teamId] : [];
                const arr = list.map(item => ({
                    pid: normalizeHashId(item.playerId),
                    name: getPlayerName(item.playerId),
                    g: parseInt(item.g) || 0,
                    a: parseInt(item.a) || 0,
                    cs: parseInt(item.cs) || 0
                }));

                const roster = getTeamRosterPlayerIds(leagueKey, teamId);
                const rosterSet = new Set(roster.map(normalizeHashId));

                const mergedIds = new Set([...arr.map(x => normalizeHashId(x.pid)), ...roster.map(normalizeHashId)]);

                const merged = Array.from(mergedIds).map(pid => {
                    const ex = arr.find(x => normalizeHashId(x.pid) === normalizeHashId(pid));
                    const g = ex ? ex.g : 0, a = ex ? ex.a : 0, cs = ex ? ex.cs : 0;
                    return { pid, name: getPlayerName(pid), g, a, cs, inRoster: rosterSet.has(normalizeHashId(pid)) };
                }).sort((x, y) => (y.g - x.g) || (y.a - x.a) || (y.cs - x.cs) || String(x.name).localeCompare(String(y.name), 'tr'));

                return `
              <div class="roster-card">
                <div class="team-cell" style="margin-bottom:8px;">
                  <img class="team-logo-small" src="${esc(team.logo || '')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                       onerror="this.src='https://via.placeholder.com/30?text=?'">
                  <div style="font-weight:1000">${esc(team.name || 'Takƒ±m')}</div>
                  <span class="pill">${esc(team.teamId || '')}</span>
                </div>
                <table>
                  <tr><th>Oyuncu</th><th>Gol</th><th>Asist</th><th>CS</th></tr>
                  ${merged.length ? merged.map(p => `
                    <tr>
                      <td>
                        ${esc(p.name)} <span class="pill">${esc(p.pid)}</span>
                        ${p.inRoster ? `` : `<span class="pill" style="border-color:rgba(255,68,68,.35);color:#ffb3b3">Kadro dƒ±≈üƒ±</span>`}
                      </td>
                      <td><b>${p.g}</b></td>
                      <td><b>${p.a}</b></td>
                      <td><b>${p.cs}</b></td>
                    </tr>
                  `).join('') : `<tr><td colspan="4" class="muted">Detay yok.</td></tr>`}
                </table>
              </div>
            `;
            };

            const body = `
            <div class="grid-2">
              ${renderTeamDetail(t1, m.t1Id)}
              ${renderTeamDetail(t2, m.t2Id)}
            </div>
            <div class="muted" style="margin-top:10px">Detaylar ma√ß kaydƒ± i√ßinden g√∂sterilir.</div>
          `;
            $('match-modal-body') && ($('match-modal-body').innerHTML = body);

            $('match-modal-backdrop') && ($('match-modal-backdrop').style.display = 'flex');
        }

        // ---------- Players ----------
        function getAllUniquePlayersIndex() {
            const map = new Map();
            (players || []).forEach(p => {
                const pid = normalizeHashId(p.playerId);
                if (!pid) return;
                if (!map.has(pid)) map.set(pid, { playerId: pid, name: p.name || "Oyuncu" });
                else if (p.name) map.get(pid).name = p.name;
            });
            return Array.from(map.values());
        }

        function computePlayerTotalsForId(playerId) {
            const pid = normalizeHashId(playerId);
            const totalsByLeague = {};

            (matches || []).forEach(m => {
                const details = m.details || {};
                const l = m.league;
                const t1 = getTeamById(l, m.t1Id);
                const t2 = getTeamById(l, m.t2Id);

                function add(teamInternalId, teamObj) {
                    const list = Array.isArray(details[teamInternalId]) ? details[teamInternalId] : [];
                    const item = list.find(x => normalizeHashId(x.playerId) === pid);
                    if (!item) return;

                    if (!totalsByLeague[l]) totalsByLeague[l] = { league: l, team: "", goals: 0, assists: 0, cs: 0 };
                    totalsByLeague[l].goals += (parseInt(item.g) || 0);
                    totalsByLeague[l].assists += (parseInt(item.a) || 0);
                    totalsByLeague[l].cs += (parseInt(item.cs) || 0);
                    if (teamObj && teamObj.name) totalsByLeague[l].team = teamObj.name;
                }

                add(m.t1Id, t1);
                add(m.t2Id, t2);
            });

            Object.keys(leagues || {}).forEach(l => {
                (leagues[l] || []).filter(t => t.id !== "dummy").forEach(t => {
                    if (Array.isArray(t.roster) && t.roster.map(normalizeHashId).includes(pid)) {
                        if (!totalsByLeague[l]) totalsByLeague[l] = { league: l, team: t.name, goals: 0, assists: 0, cs: 0 };
                        if (!totalsByLeague[l].team) totalsByLeague[l].team = t.name;
                    }
                });
            });

            return Object.values(totalsByLeague).sort((a, b) => String(a.league).localeCompare(String(b.league)));
        }

        function renderPlayersList() {
            const wrap = $('players-list');
            if (!wrap) return;

            const uniq = getAllUniquePlayersIndex();
            wrap.innerHTML = uniq.map(p => `
            <div class="mini-card" onclick="showPlayersDetail('${esc(p.playerId)}')">
              <div class="row">
                <div style="font-weight:900">${esc(p.name)} <span class="pill">${esc(p.playerId)}</span></div>
                ${isAdmin ? `<button class="btn-danger btn-small" onclick="event.stopPropagation(); deletePlayerById('${esc(p.playerId)}')">Sil</button>` : ``}
              </div>
              <div class="muted">Detay i√ßin tƒ±kla</div>
            </div>
          `).join('') || `<div class="muted">Oyuncu bulunamadƒ±.</div>`;
        }

        function showPlayersDetail(playerId) {
            const box = $('players-detail');
            if (!box) return;

            const pid = normalizeHashId(playerId);
            const name = getPlayerName(pid);
            const leaguesList = computePlayerTotalsForId(pid);

            box.style.display = 'block';
            box.innerHTML = `
            <div class="row" style="margin-bottom:10px">
              <div>
                <div style="font-size:1.12rem;font-weight:1000">${esc(name)} <span class="pill">${esc(pid)}</span></div>
                <div class="muted">Liglere g√∂re (ma√ßlardan dinamik hesap)</div>
              </div>
              <div class="row">
                <button class="linkbtn" onclick="$('players-detail').style.display='none'">Kapat</button>
                ${isAdmin ? `<button class="btn-danger btn-small" onclick="deletePlayerById('${esc(pid)}')">Oyuncuyu Sil</button>` : ``}
              </div>
            </div>

            <h3>Lig Bazlƒ± ƒ∞statistik</h3>
            <table>
              <tr><th>Lig</th><th>Takƒ±m</th><th>Gol</th><th>Asist</th><th>CS</th></tr>
              ${leaguesList.map(x => `
                <tr>
                  <td>${esc(leaguesMeta[x.league] || x.league)}</td>
                  <td>${esc(x.team || '‚Äî')}</td>
                  <td><b>${x.goals}</b></td>
                  <td><b>${x.assists}</b></td>
                  <td><b>${x.cs}</b></td>
                </tr>
              `).join('')}
            </table>
          `;
            box.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function deletePlayerById(playerId) {
            const pid = normalizeHashId(playerId);
            if (!confirm("Bu oyuncu silinsin mi? (Kadro listelerinden kaldƒ±rƒ±lƒ±r. Ma√ß ge√ßmi≈üindeki istatistikler korunur.)")) return;

            players = (players || []).filter(p => normalizeHashId(p.playerId) !== pid);

            Object.keys(leagues || {}).forEach(l => {
                (leagues[l] || []).forEach(t => {
                    if (t && t.id !== "dummy" && Array.isArray(t.roster)) {
                        t.roster = t.roster.map(normalizeHashId).filter(x => x && x !== pid);
                    }
                });
            });

            save();
            alert("Oyuncu silindi!");
            $('players-detail') && ($('players-detail').style.display = 'none');
            renderPlayersList();
            renderTeamsList();
            renderStats();
        }

        function createOrOverwritePlayer() {
            const l = $('player-create-league')?.value || "";
            const rawId = ($('player-id-input')?.value || "").trim();
            const name = ($('player-name-input')?.value || "").trim();

            if (!l) return alert("Lig se√ßin!");
            if (!rawId || !isValidHashId(rawId)) return alert("Oyuncu ID ge√ßersiz! (# ile ba≈ülayacak, sadece harf/rakam).");
            if (!name) return alert("Oyuncu adƒ± girin!");

            const pid = normalizeHashId(rawId);
            const ex = (players || []).find(p => normalizeHashId(p.playerId) === pid);
            if (ex) ex.name = name;
            else players.push({ id: Date.now(), playerId: pid, name });

            if ($('player-id-input')) $('player-id-input').value = "";
            if ($('player-name-input')) $('player-name-input').value = "";

            save();
            alert("Oyuncu kaydedildi!");
        }

        function updateAssignTeams() {
            const l = $('player-assign-league')?.value || "";
            const s = $('player-assign-team');
            if (!s) return;
            const prev = s.value;

            s.innerHTML = '<option value="">Takƒ±m Se√ßin</option>';
            (leagues[l] || []).forEach(t => {
                if (t.id !== "dummy") s.innerHTML += `<option value="${esc(t.id)}">${esc(t.name)}</option>`;
            });
            s.value = prev;
        }

        function assignPlayerToTeam() {
            const l = $('player-assign-league')?.value || "";
            const teamInternalId = $('player-assign-team')?.value || "";
            const rawPid = ($('player-assign-id')?.value || "").trim();

            if (!l || !teamInternalId) return alert("Lig ve takƒ±m se√ßin!");
            if (!rawPid || !isValidHashId(rawPid)) return alert("Oyuncu ID ge√ßersiz!");

            const pid = normalizeHashId(rawPid);
            const team = getTeamById(l, teamInternalId);
            if (!team) return alert("Takƒ±m bulunamadƒ±!");

            // registry yoksa olu≈ütur
            if (!(players || []).some(p => normalizeHashId(p.playerId) === pid)) {
                players.push({ id: Date.now(), playerId: pid, name: "Oyuncu" });
            }

            // diƒüer takƒ±mlardan √ßƒ±kar (aynƒ± lig i√ßinde)
            (leagues[l] || []).forEach(t => {
                if (t.id !== "dummy" && Array.isArray(t.roster)) {
                    t.roster = t.roster.map(normalizeHashId).filter(x => x && x !== pid);
                }
            });

            if (!Array.isArray(team.roster)) team.roster = [];
            if (!team.roster.map(normalizeHashId).includes(pid)) team.roster.push(pid);

            save();
            alert("Oyuncu takƒ±ma eklendi!");
            if ($('player-assign-id')) $('player-assign-id').value = "";
            renderPlayersList();
            renderTeamsList();
            renderMatchDetailInputs();
        }

        // ---------- Teams ----------
        function findTeamByTeamId(teamId) {
            const tid = normalizeHashId(teamId);
            for (const l of Object.keys(leagues || {})) {
                if (!Array.isArray(leagues[l])) continue;
                const t = (leagues[l] || []).find(x => x && x.id !== "dummy" && normalizeHashId(x.teamId) === tid);
                if (t) return { leagueKey: l, leagueName: leaguesMeta[l] || l, team: t };
            }
            return null;
        }

        function renderTeamsList() {
            const wrap = $('teams-list');
            if (!wrap) return;

            let all = [];
            Object.keys(leagues || {}).forEach(l => {
                if (!Array.isArray(leagues[l])) return;
                leagues[l].filter(t => t.id !== "dummy").forEach(t => all.push({ leagueKey: l, leagueName: leaguesMeta[l] || l, team: t }));
            });

            const leagueAgg = {};
            Object.keys(leagues || {}).forEach(l => {
                if (Array.isArray(leagues[l])) leagueAgg[l] = buildLeagueAggregates(l).teamStats;
            });

            wrap.innerHTML = all.map(x => {
                const st = (leagueAgg[x.leagueKey] || {})[x.team.id] || { pts: 0, gd: 0 };
                return `
              <div class="mini-card" onclick="showTeamDetail('${esc(x.team.teamId)}')">
                <div class="row">
                  <div class="team-cell">
                    <img class="team-logo-small" src="${esc(x.team.logo || '')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                         onerror="this.src='https://via.placeholder.com/30?text=?'">
                    <div>
                      <div style="font-weight:900">${esc(x.team.name)}</div>
                      <div class="muted">${esc(x.leagueName)} ‚Ä¢ <span class="pill">${esc(x.team.teamId)}</span></div>
                    </div>
                  </div>
                  <div class="pill">P: ${st.pts} ‚Ä¢ AV: ${st.gd}</div>
                </div>
                <div class="muted" style="margin-top:6px">Kadro i√ßin tƒ±kla</div>
              </div>
            `;
            }).join('') || `<div class="muted">Takƒ±m bulunamadƒ±.</div>`;
        }

        function showTeamDetail(teamId) {
            const box = $('teams-detail');
            if (!box) return;

            const found = findTeamByTeamId(teamId);
            if (!found) {
                box.style.display = 'block';
                box.innerHTML = `<h3>Takƒ±m bulunamadƒ±</h3><div class="muted">Bu ID ile takƒ±m yok.</div>`;
                return;
            }

            const { leagueKey, leagueName, team } = found;
            const roster = Array.isArray(team.roster) ? team.roster.map(normalizeHashId).filter(Boolean) : [];

            const { teamStats } = buildLeagueAggregates(leagueKey);
            const st = teamStats[team.id] || { pts: 0, gd: 0, played: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0 };

            const rosterRows = roster.map(pid => {
                const totals = computePlayerTotalsForId(pid).find(x => x.league === leagueKey) || { goals: 0, assists: 0, cs: 0 };
                return { pid, nm: getPlayerName(pid), g: totals.goals || 0, a: totals.assists || 0, cs: totals.cs || 0 };
            }).sort((x, y) => (y.g - x.g) || (y.a - x.a) || (y.cs - x.cs) || String(x.nm).localeCompare(String(y.nm), 'tr'));

            box.style.display = 'block';
            box.innerHTML = `
            <div class="row" style="margin-bottom:10px">
              <div class="team-cell">
                <img class="team-logo-small" src="${esc(team.logo || '')}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                     onerror="this.src='https://via.placeholder.com/30?text=?'">
                <div>
                  <div style="font-size:1.12rem;font-weight:1000">${esc(team.name)} <span class="pill">${esc(team.teamId)}</span></div>
                  <div class="muted">${esc(leagueName)} ‚Ä¢ P: <b>${st.pts}</b> ‚Ä¢ AV: <b>${st.gd}</b> ‚Ä¢ O: ${st.played}</div>
                </div>
              </div>
              <div class="row">
                <button class="linkbtn" onclick="$('teams-detail').style.display='none'">Kapat</button>
                ${isAdmin ? `<button class="btn-danger btn-small" onclick="deleteTeamById('${esc(team.teamId)}')">Takƒ±mƒ± Sil</button>` : ``}
              </div>
            </div>

            <h3>Kadro</h3>
            ${rosterRows.length ? `
              <table>
                <tr><th>Oyuncu</th><th>Gol</th><th>Asist</th><th>CS</th></tr>
                ${rosterRows.map(r => `
                  <tr style="cursor:pointer" onclick="handleNav('players'); showPlayersDetail('${esc(r.pid)}')">
                    <td>${esc(r.nm)} <span class="pill">${esc(r.pid)}</span></td>
                    <td><b>${r.g}</b></td>
                    <td><b>${r.a}</b></td>
                    <td><b>${r.cs}</b></td>
                  </tr>
                `).join('')}
              </table>
              <div class="muted" style="margin-top:8px">Oyuncuya tƒ±klayƒ±nca oyuncu detayƒ±na gider.</div>
            ` : `<div class="muted">Kadro bo≈ü.</div>`}
          `;
            box.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function deleteTeamById(teamId) {
            const found = findTeamByTeamId(teamId);
            if (!found) return alert("Takƒ±m bulunamadƒ±!");
            const { leagueKey, team } = found;

            if (!confirm(`${team.name} takƒ±mƒ± tamamen silinsin mi? (Kadro temizlenir, ma√ß ge√ßmi≈üi korunur.)`)) return;

            leagues[leagueKey] = (leagues[leagueKey] || []).filter(t => t.id !== team.id);
            save();
            alert("Takƒ±m silindi!");
            renderTeamsList();
            $('teams-detail') && ($('teams-detail').style.display = 'none');

            updateMatchTeams();
            renderMatchDetailInputs();
        }

        // ---------- Stats ----------
        function renderStats() {
            const container = $('stats-display-container');
            if (!container) return;
            container.innerHTML = "";

            Object.keys(leagues || {}).forEach(l => {
                if (!Array.isArray(leagues[l])) return;

                const { playerStats } = buildLeagueAggregates(l);
                const list = Object.values(playerStats || {});
                if (!list.length) return;

                const dn = leaguesMeta[l] || l;
                let html = `<h2>${esc(dn)} - ƒ∞statistikler</h2><div class="stats-grid">`;

                const goals = list.filter(p => p.goals > 0).sort((a, b) => b.goals - a.goals).slice(0, 5);
                html += `<div class="stats-card"><h3>Gol Krallƒ±ƒüƒ±</h3><table>`;
                goals.forEach(p => {
                    html += `<tr style="cursor:pointer" onclick="handleNav('players'); showPlayersDetail('${esc(p.playerId)}')">
                <td>${esc(p.name)} <span class="pill">${esc(p.playerId)}</span></td>
                <td style="text-align:right"><b>${p.goals}</b></td>
              </tr>`;
                });
                html += `</table></div>`;

                const assists = list.filter(p => p.assists > 0).sort((a, b) => b.assists - a.assists).slice(0, 5);
                html += `<div class="stats-card"><h3>Asist Krallƒ±ƒüƒ±</h3><table>`;
                assists.forEach(p => {
                    html += `<tr style="cursor:pointer" onclick="handleNav('players'); showPlayersDetail('${esc(p.playerId)}')">
                <td>${esc(p.name)} <span class="pill">${esc(p.playerId)}</span></td>
                <td style="text-align:right"><b>${p.assists}</b></td>
              </tr>`;
                });
                html += `</table></div>`;

                const clean = list.filter(p => p.cs > 0).sort((a, b) => b.cs - a.cs).slice(0, 5);
                html += `<div class="stats-card"><h3>CS Krallƒ±ƒüƒ±</h3><table>`;
                clean.forEach(p => {
                    html += `<tr style="cursor:pointer" onclick="handleNav('players'); showPlayersDetail('${esc(p.playerId)}')">
                <td>${esc(p.name)} <span class="pill">${esc(p.playerId)}</span></td>
                <td style="text-align:right"><b>${p.cs}</b></td>
              </tr>`;
                });
                html += `</table></div>`;

                html += `</div>`;
                container.innerHTML += html;
            });
        }

        // ---------- Select updates ----------
        function updateLeagueSelects() {
            const leagueKeys = Object.keys(leagues || {}).filter(k => Array.isArray(leagues[k]));
            const ids = ['team-league-select', 'match-league-select', 'fixture-league-select', 'player-create-league', 'player-assign-league'];
            ids.forEach(id => {
                const s = $(id);
                if (!s) return;
                const val = s.value;
                s.innerHTML = '<option value="">Lig Se√ßin</option>' + leagueKeys.map(l => {
                    const dn = leaguesMeta[l] || l;
                    return `<option value="${esc(l)}">${esc(dn)}</option>`;
                }).join('');
                s.value = val;
            });

            if ($('webhook-input')) $('webhook-input').value = DISCORD_WEBHOOK_URL || "";

            if ($('match-league-select') && $('match-league-select').value) {
                updateMatchTeams();
            }
        }

        // ---------- Render all ----------
        function renderAll() {
            renderNews();
            renderStandings();
            renderFixture();
            renderStats();
            renderMatches();
        }

        // ---------- Init ----------
        function initWeekSelect() {
            const s = $('match-week-select');
            if (!s) return;
            if (s.dataset.inited === "1") return;
            s.dataset.inited = "1";
            for (let i = 1; i <= 30; i++) {
                s.innerHTML += `<option value="${i}">${i}</option>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initWeekSelect();
            handleNav('news');
            $('match-detail-inputs') && ($('match-detail-inputs').innerHTML = `<div class="muted">Takƒ±mlarƒ± se√ßince kadrolar otomatik listelenir (Gol/Asist/CS girebilirsin).</div>`);
        });
    </script>
</body>
</html>
